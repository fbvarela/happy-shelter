<html>

  <head>
    <title>REFUGIO ANIMAL</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
    <script type="text/javascript" src="https://unpkg.com/fabric@4.0.0-beta.8/dist/fabric.js"></script>
  </head>

  <body>
    
    <pre data-lang="html">
      <h1 style="width: 100%;text-align: center;">DISEÑA LAS ÁREAS DE TU REFUGIO ANIMAL</h1>            
      <div class="input-group">
        <button onclick="AddArea()">Añadir nuevo área</button>&nbsp;<button onclick="RemoveArea()">Eliminar ultimo área</button>&nbsp;<button onclick="SaveMap()">Guardar áreas</button>
      </div>
      <div id="mapas" class="row"></div>  
    </pre>
  
    <script>
      var canvas = [];
      var lados  = [];
      var r      = 50;
      function init(id) {
          changeLabel(id);
          fabric.Object.prototype.originX = fabric.Object.prototype.originY = 'center';
          var cx = canvas[id].getWidth() / 2;
          var cy = canvas[id].getHeight() / 2;
          var a = 360/lados[id];
          var lines =new Array();
          for(var i=0;i < lados[id];i++){
              var aRad=  (Math.PI / 180) * (a*(i+1));
              Xp = cx+r * Math.cos(aRad);
              Yp = cy+r * Math.sin(aRad);
              lines[i]={x2:Xp, y2:Yp};
              if(i != 0){
                lines[i] = makeLine([lines[i-1].x2, lines[i-1].y2, Xp, Yp]);
                canvas[id].add(lines[i]);
                if(i != 1){
                  canvas[id].add(makeCircle(lines[i].get('x1'), lines[i].get('y1'), lines[i-1], lines[i]));
                }               
                if(i == lados[id]-1){
                  lines[0] = makeLine([Xp, Yp, lines[0].x2, lines[0].y2]);
                  canvas[id].add(
                    lines[0],
                    makeCircle(lines[0].get('x1'), lines[0].get('y1'), lines[lines.length-1], lines[0]),
                    makeCircle(lines[1].get('x1'), lines[1].get('y1'), lines[0], lines[1])
                  );         
                }
              }              
          }

          canvas[id].on('object:moving', function(e) {
            canvas[id].getObjects('circle').forEach((obj) => {
                obj.line1.angle=0;
                obj.line1 && obj.line1.set({ 'x2':obj.getPointByOrigin().x, 'y2': obj.getPointByOrigin().y});
                obj.line2 && obj.line2.set({ 'x1':obj.getPointByOrigin().x, 'y1': obj.getPointByOrigin().y});
            });    
            canvas[id].renderAll();    
          });

      }

      function makeCircle(left, top, line1, line2) {
        var c = new fabric.Circle({
          left: left,
          top: top,
          strokeWidth: 1,
          radius: 3,
          fill: '#fff',
          stroke: '#666',
        });
        c.hasControls = c.hasBorders = false;
        c.line1 = line1;
        c.line2 = line2;
        return c;
      }

      function makeLine(coords) {
        return new fabric.Line(coords, {
          fill: 'red',
          stroke: 'red',
          strokeWidth: 1,
          selectable: false
        });
      }

      function RemoveLine(id) {
        if(lados[id]!=3){
          canvas[id].clear();
          var newLados= lados[id]-1;
          lados[id]=newLados;
          init(id);  
        }            
      }
      function Rotate(id,angleOffset) {     
        let canvasCenter = new fabric.Point(canvas[id].getWidth() / 2, canvas[id].getHeight() / 2);
        let radians = fabric.util.degreesToRadians(angleOffset);
        canvas[id].getObjects().forEach((obj) => {
            let objectOrigin = new fabric.Point(obj.left, obj.top);
            let new_loc = fabric.util.rotatePoint(objectOrigin, canvasCenter, radians);
            obj.top = new_loc.y;
            obj.left = new_loc.x;
            obj.angle += Number(angleOffset);
            obj.setCoords();
        });
        canvas[id].renderAll();
      }

      function RotateMenos(id) {     
        var e = document.getElementById("grados_"+id);
        Rotate(id,e.options[e.selectedIndex].value);
      }

      function RotateMas(id) {   
        var e = document.getElementById("grados_"+id);
        Rotate(id,Math.abs(e.options[e.selectedIndex].value));  
      }


      function AddLine(id) {
        canvas[id].clear();
        var newLados= lados[id]+1;
        lados[id]=newLados;
        init(id);      
      }
      function RemoveArea(){
        var list = document.getElementById("mapas"); 
        list.removeChild(list.childNodes[lados.length-1]);     
        canvas.pop();
        lados.pop();
      }

      function AddArea() {
        var nombreArea = prompt("¿Nombre del Área?",'Área '+(lados.length+1));
        if(nombreArea==null){
          return;
        }
        if(nombreArea.length==0){
          nombreArea='Área '+(lados.length+1);
        }
        var capa = document.getElementById("mapas");
        var div = document.createElement('div');
        div.setAttribute("id", "div_"+lados.length);
        div.setAttribute("class", "col-sm-6 col-lg-3");
        capa.appendChild(div);
        var newDiv = document.getElementById("div_"+lados.length);
        newDiv.innerHTML += '<h1>'+nombreArea+'</h1>'
        +'<button onclick="RemoveLine('+lados.length+',90)">-</button>'
        +'<span id="numLineas_'+lados.length+'"></span>'
        +'&nbsp;<button onclick="AddLine('+lados.length+')">+</button>'
        +'&nbsp;<button onclick="RotateMenos('+lados.length+')"><</button>'
        +'&nbsp;<select id="grados_'+lados.length+'"><option value="-20">20°</option><option value="-45">45°</option><option value="-60">60°</option><option value="-90">90°</option><option value="-180">180°</option></select>'
        +'&nbsp;<button onclick="RotateMas('+lados.length+')">></button>'
        +'<canvas id="c_'+lados.length+'" width="320" height="450" style="border:1px solid #ccc"></canvas>';
        
        canvas[lados.length]=new fabric.Canvas('c_'+lados.length, { selection: false});
        lados[lados.length]=3;
        init(lados.length-1);
      }

      function changeLabel(id){
        document.getElementById("numLineas_"+id).innerHTML = " Num. puntos: "+lados[id];
      }

      function SaveMap() {
        canvas.forEach(function (canva,i) {
          console.log("Area "+i);
          canva.getObjects('line').forEach(function (obj) {
            console.log("x1="+obj.x1+" y1="+obj.y1+" x2="+obj.x2+" y2="+obj.y2);
          });
        });   
      }
    </script>

  </body>
</html>